//- orders/detail.pug â€” detalle completo con control de estado

extends ../layout

block content
  h2 Pedido ##{order._id.toString().slice(-4)} ðŸ§¾

  //- InformaciÃ³n del cliente
  h3 Cliente
  ul
    li strong Nombre: #{order.buyer_name}
    li strong DirecciÃ³n: #{order.address}
    li strong Email: #{order.email}
    li strong Sector: #{order.igloo_sector}

  //- Detalle de productos
  h3 Productos
  ul
    each it in order.items
      li #{it.qty}x #{it.name} â€” $#{it.unit_price} (subtotal: $#{it.subtotal})

  p(style="margin-top:1rem") strong Total: $#{order.total}

  //- Estado actual y cambio de estado
  h3 Estado actual
  p(style="font-weight:bold") #{order.status}

  if order.status !== 'en_camino'
    form(method="POST" action=`/orders/${order._id}/status` style="margin-top:1rem")
      input(type="hidden" name="token" value=token)
      input(type="hidden" name="csrf_token" value=csrf_token)
      label(for="next_status") Cambiar a:
      select(name="next_status" required)
        if order.status === 'nuevo'
          option(value="preparando") preparando
          option(value="en_camino") en camino
        if order.status === 'preparando'
          option(value="en_camino") en camino
      button(type="submit") Actualizar estado

  //- Marcar como entregado
  if order.status === 'en_camino'
    form(method="POST" action=`/orders/${order._id}/deliver` style="margin-top:1.5rem")
      input(type="hidden" name="token" value=token)
      input(type="hidden" name="csrf_token" value=csrf_token)
      button(type="submit" style="background:#065f46; color:white") Marcar como entregado

  //- Volver al listado
  form(method="POST" action="/orders" style="margin-top:2rem")
    input(type="hidden" name="token" value=token)
    input(type="hidden" name="csrf_token" value=csrf_token)
    button(type="submit" style="background:#6b7280") Volver
